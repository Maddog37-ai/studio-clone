<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialize Chat Channels</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            min-width: 200px;
        }
        button:hover {
            background: #0056CC;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .warning {
            color: #ffc107;
        }
        .info {
            color: #17a2b8;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .auth-status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .auth-status.authenticated {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auth-status.unauthenticated {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Initialize Chat Channels</h1>
        
        <div id="auth-status" class="auth-status unauthenticated">
            Authentication Status: Not authenticated
        </div>
        
        <button id="login-btn" onclick="signIn()">Sign In with Google</button>
        <button id="init-btn" onclick="initializeChannels()" disabled>Initialize Chat Channels</button>
        <button id="test-btn" onclick="testChatService()" disabled>Test Chat Service</button>
        
        <div id="log" class="log">Ready to initialize chat channels...\n</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            setDoc, 
            updateDoc,
            getDoc,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc3jmFE6dRXBApmWD9Jg2PO86suqGgaZw",
            authDomain: "leadflow-4lvrr.firebaseapp.com",
            projectId: "leadflow-4lvrr",
            storageBucket: "leadflow-4lvrr.appspot.com",
            messagingSenderId: "13877630896",
            appId: "1:13877630896:web:ab7d2717024960ec36e875",
            measurementId: "G-KDEF2C21SH",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        // Elements
        const authStatus = document.getElementById('auth-status');
        const loginBtn = document.getElementById('login-btn');
        const initBtn = document.getElementById('init-btn');
        const testBtn = document.getElementById('test-btn');
        const logElement = document.getElementById('log');

        // Log functionality
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '‚úÖ',
                error: '‚ùå', 
                warning: '‚ö†Ô∏è',
                info: 'üìä'
            };
            
            const prefix = colors[type] || 'üìä';
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Authentication state listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authStatus.textContent = `Authentication Status: Signed in as ${user.email}`;
                authStatus.className = 'auth-status authenticated';
                loginBtn.style.display = 'none';
                initBtn.disabled = false;
                testBtn.disabled = false;
                log(`Authenticated as ${user.email}`, 'success');
            } else {
                authStatus.textContent = 'Authentication Status: Not authenticated';
                authStatus.className = 'auth-status unauthenticated';
                loginBtn.style.display = 'inline-block';
                initBtn.disabled = true;
                testBtn.disabled = true;
                log('Authentication required', 'warning');
            }
        });

        // Sign in function
        window.signIn = async function() {
            try {
                log('Signing in with Google...', 'info');
                const result = await signInWithPopup(auth, provider);
                log(`Successfully signed in as ${result.user.email}`, 'success');
            } catch (error) {
                log(`Sign in failed: ${error.message}`, 'error');
            }
        };

        // Initialize chat channels
        window.initializeChannels = async function() {
            if (!currentUser) {
                log('Please sign in first', 'error');
                return;
            }

            try {
                log('üöÄ Starting chat channel initialization...', 'info');
                initBtn.disabled = true;
                initBtn.textContent = 'Initializing...';

                // Get all teams
                log('üìä Fetching teams...', 'info');
                const teamsSnapshot = await getDocs(collection(db, 'teams'));
                const teams = teamsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`Found ${teams.length} teams to process`, 'info');

                // Initialize region channel first
                const regionChannelId = 'empire-region';
                const regionChannelRef = doc(db, 'chatChannels', regionChannelId);
                const regionChannelDoc = await getDoc(regionChannelRef);

                if (!regionChannelDoc.exists()) {
                    await setDoc(regionChannelRef, {
                        name: 'Empire Region',
                        type: 'region',
                        teamId: null,
                        memberCount: teams.length,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        isActive: true
                    });
                    log('‚úÖ Created Empire Region channel', 'success');
                } else {
                    // Update member count
                    await updateDoc(regionChannelRef, {
                        memberCount: teams.length,
                        updatedAt: serverTimestamp()
                    });
                    log('‚úÖ Updated Empire Region channel member count', 'success');
                }

                // Initialize team channels
                let processedCount = 0;
                let createdCount = 0;
                let updatedCount = 0;

                for (const team of teams) {
                    const teamChannelId = `team-${team.id}`;
                    const teamChannelRef = doc(db, 'chatChannels', teamChannelId);
                    const teamChannelDoc = await getDoc(teamChannelRef);

                    if (!teamChannelDoc.exists()) {
                        await setDoc(teamChannelRef, {
                            name: team.name || 'Unnamed Team',
                            type: 'team',
                            teamId: team.id,
                            memberCount: 1, // Default to 1, will be updated by cloud functions
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp(),
                            isActive: true
                        });
                        createdCount++;
                        log(`‚úÖ Created channel for team: ${team.name || team.id}`, 'success');
                    } else {
                        // Update existing channel
                        await updateDoc(teamChannelRef, {
                            name: team.name || 'Unnamed Team',
                            updatedAt: serverTimestamp(),
                            isActive: true
                        });
                        updatedCount++;
                        log(`üîÑ Updated channel for team: ${team.name || team.id}`, 'info');
                    }

                    processedCount++;
                }

                log('üéâ Chat channel initialization complete!', 'success');
                log(`üìà Summary:`, 'info');
                log(`   - Teams processed: ${processedCount}`, 'info');
                log(`   - Channels created: ${createdCount}`, 'success');
                log(`   - Channels updated: ${updatedCount}`, 'info');
                log(`   - Region channel: ‚úÖ Ready`, 'success');

            } catch (error) {
                log(`‚ùå Error initializing chat channels: ${error.message}`, 'error');
                console.error('Detailed error:', error);
            } finally {
                initBtn.disabled = false;
                initBtn.textContent = 'Initialize Chat Channels';
            }
        };

        // Test chat service
        window.testChatService = async function() {
            if (!currentUser) {
                log('Please sign in first', 'error');
                return;
            }

            try {
                log('üß™ Testing chat service...', 'info');
                testBtn.disabled = true;
                testBtn.textContent = 'Testing...';

                // Test 1: Check if channels exist
                log('Test 1: Checking if channels exist...', 'info');
                const channelsSnapshot = await getDocs(collection(db, 'chatChannels'));
                log(`Found ${channelsSnapshot.size} chat channels`, channelsSnapshot.size > 0 ? 'success' : 'warning');

                // Test 2: List all channels
                if (channelsSnapshot.size > 0) {
                    log('Test 2: Listing all channels:', 'info');
                    channelsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        log(`  - ${data.name} (${data.type}) - ${data.memberCount} members`, 'info');
                    });
                }

                // Test 3: Send a test message to region channel
                log('Test 3: Sending test message to region channel...', 'info');
                const testMessageRef = doc(collection(db, 'chatMessages'));
                await setDoc(testMessageRef, {
                    channelId: 'empire-region',
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    content: 'Test message from chat initialization! üéâ',
                    timestamp: serverTimestamp(),
                    edited: false,
                    type: 'text'
                });
                log('‚úÖ Test message sent successfully', 'success');

                log('üéâ All tests completed successfully!', 'success');

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Detailed error:', error);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Chat Service';
            }
        };

        // Initial log
        log('üîß Chat Channel Initializer ready', 'info');
        log('Please sign in to continue', 'warning');

    </script>
</body>
</html>
