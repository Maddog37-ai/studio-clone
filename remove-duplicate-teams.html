<!DOCTYPE html>
<html>
<head>
    <title>Remove Duplicate Teams</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            deleteDoc,
            updateDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc3jmFE6dRXBApmWD9Jg2PO86suqGgaZw",
            authDomain: "leadflow-4lvrr.firebaseapp.com",
            projectId: "leadflow-4lvrr",
            storageBucket: "leadflow-4lvrr.appspot.com",
            messagingSenderId: "13877630896",
            appId: "1:13877630896:web:ab7d2717024960ec36e875",
            measurementId: "G-KDEF2C21SH",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // The ONLY teams we want to keep (exact IDs)
        const TEAMS_TO_KEEP = [
            'empire',        // Keep the main Empire team
            'revolution',    // Keep Revolution (Empire) 
            'takeover-pros'  // Keep TakeoverPros (Empire)
        ];

        async function removeDuplicateTeams() {
            console.log('ğŸš€ Starting duplicate team removal...\n');

            try {
                // Step 1: Get all current teams
                console.log('ğŸ“‹ Step 1: Fetching all teams...');
                const teamsSnapshot = await getDocs(collection(db, 'teams'));
                const allTeams = teamsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name,
                    description: doc.data().description,
                    isActive: doc.data().isActive
                }));

                console.log(`Found ${allTeams.length} total teams:`);
                allTeams.forEach(team => {
                    const action = TEAMS_TO_KEEP.includes(team.id) ? 'âœ… KEEP' : 'ğŸ—‘ï¸ DELETE';
                    console.log(`   ${action} - ${team.name} (ID: ${team.id})`);
                });

                // Step 2: Identify teams to delete
                const teamsToDelete = allTeams.filter(team => !TEAMS_TO_KEEP.includes(team.id));
                const teamsToKeep = allTeams.filter(team => TEAMS_TO_KEEP.includes(team.id));

                console.log(`\nğŸ“Š Summary:`);
                console.log(`   Teams to keep: ${teamsToKeep.length}`);
                console.log(`   Teams to delete: ${teamsToDelete.length}`);

                if (teamsToDelete.length === 0) {
                    console.log('\nâœ… No duplicate teams found to delete!');
                    document.getElementById('status').innerHTML = `
                        <div style="color: green; font-weight: bold;">âœ… No duplicate teams found!</div>
                        <div>All teams are already cleaned up.</div>
                    `;
                    return;
                }

                // Step 3: Before deleting, reassign any users/closers/leads from duplicate teams to Empire
                console.log('\nğŸ”„ Step 3: Reassigning data from duplicate teams to Empire...');
                
                // Check users assigned to teams we're about to delete
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const usersToReassign = [];
                
                usersSnapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    if (userData.teamId && teamsToDelete.some(team => team.id === userData.teamId)) {
                        usersToReassign.push({
                            uid: doc.id,
                            currentTeamId: userData.teamId,
                            ...userData
                        });
                    }
                });

                if (usersToReassign.length > 0) {
                    console.log(`ğŸ‘¥ Reassigning ${usersToReassign.length} users to Empire team:`);
                    for (const user of usersToReassign) {
                        console.log(`   - ${user.displayName || user.email} (from ${user.currentTeamId})`);
                        const userRef = doc(db, 'users', user.uid);
                        await updateDoc(userRef, {
                            teamId: 'empire',
                            updatedAt: serverTimestamp()
                        });
                    }
                } else {
                    console.log('âœ… No users need reassignment');
                }

                // Check closers
                const closersSnapshot = await getDocs(collection(db, 'closers'));
                const closersToReassign = [];
                
                closersSnapshot.docs.forEach(doc => {
                    const closerData = doc.data();
                    if (closerData.teamId && teamsToDelete.some(team => team.id === closerData.teamId)) {
                        closersToReassign.push({
                            uid: doc.id,
                            currentTeamId: closerData.teamId,
                            ...closerData
                        });
                    }
                });

                if (closersToReassign.length > 0) {
                    console.log(`ğŸ¯ Reassigning ${closersToReassign.length} closers to Empire team:`);
                    for (const closer of closersToReassign) {
                        console.log(`   - ${closer.name} (from ${closer.currentTeamId})`);
                        const closerRef = doc(db, 'closers', closer.uid);
                        await updateDoc(closerRef, {
                            teamId: 'empire',
                            updatedAt: serverTimestamp()
                        });
                    }
                } else {
                    console.log('âœ… No closers need reassignment');
                }

                // Check leads
                const leadsSnapshot = await getDocs(collection(db, 'leads'));
                const leadsToReassign = [];
                
                leadsSnapshot.docs.forEach(doc => {
                    const leadData = doc.data();
                    if (leadData.teamId && teamsToDelete.some(team => team.id === leadData.teamId)) {
                        leadsToReassign.push({
                            id: doc.id,
                            currentTeamId: leadData.teamId
                        });
                    }
                });

                if (leadsToReassign.length > 0) {
                    console.log(`ğŸ“Š Reassigning ${leadsToReassign.length} leads to Empire team...`);
                    // Process in batches to avoid overwhelming Firestore
                    const batchSize = 50;
                    for (let i = 0; i < leadsToReassign.length; i += batchSize) {
                        const batch = leadsToReassign.slice(i, i + batchSize);
                        const promises = batch.map(lead => {
                            const leadRef = doc(db, 'leads', lead.id);
                            return updateDoc(leadRef, {
                                teamId: 'empire',
                                updatedAt: serverTimestamp()
                            });
                        });
                        await Promise.all(promises);
                        console.log(`   - Processed ${Math.min(i + batchSize, leadsToReassign.length)}/${leadsToReassign.length} leads`);
                    }
                } else {
                    console.log('âœ… No leads need reassignment');
                }

                // Step 4: Delete duplicate teams
                console.log('\nğŸ—‘ï¸ Step 4: Deleting duplicate teams...');
                const deletePromises = teamsToDelete.map(team => {
                    console.log(`ğŸ—‘ï¸ Deleting: ${team.name} (ID: ${team.id})`);
                    return deleteDoc(doc(db, 'teams', team.id));
                });

                await Promise.all(deletePromises);
                console.log(`âœ… Successfully deleted ${teamsToDelete.length} duplicate teams`);

                // Step 5: Verify final state
                console.log('\nğŸ” Step 5: Verifying final state...');
                const finalTeamsSnapshot = await getDocs(collection(db, 'teams'));
                const remainingTeams = finalTeamsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name
                }));

                console.log('ğŸ“‹ Remaining teams:');
                remainingTeams.forEach(team => {
                    console.log(`   âœ… ${team.name} (${team.id})`);
                });

                // Update page with results
                document.getElementById('status').innerHTML = `
                    <div style="color: green; font-weight: bold;">âœ… Duplicate team removal completed!</div>
                    <div style="margin: 15px 0;">
                        <h4>ğŸ“Š Summary:</h4>
                        <ul>
                            <li>Teams deleted: ${teamsToDelete.length}</li>
                            <li>Users reassigned: ${usersToReassign.length}</li>
                            <li>Closers reassigned: ${closersToReassign.length}</li>
                            <li>Leads reassigned: ${leadsToReassign.length}</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                        <h4>ğŸ“‹ Remaining Teams (${remainingTeams.length}):</h4>
                        ${remainingTeams.map(team => `<div>âœ… ${team.name} (${team.id})</div>`).join('')}
                    </div>
                `;

                console.log('\nğŸ‰ Duplicate team removal completed successfully!');

            } catch (error) {
                console.error('âŒ Team removal failed:', error);
                document.getElementById('status').innerHTML = `
                    <div style="color: red; font-weight: bold;">âŒ Team removal failed!</div>
                    <div>Error: ${error.message}</div>
                `;
                throw error;
            }
        }

        // Auto-run when page loads
        window.addEventListener('load', () => {
            document.getElementById('status').innerHTML = '<div>ğŸš€ Starting duplicate team removal...</div>';
            removeDuplicateTeams();
        });
    </script>
</head>
<body>
    <h1>Remove Duplicate Teams</h1>
    <p>This script will remove ALL duplicate teams and keep only these 3 teams:</p>
    <ul>
        <li><strong>Empire</strong> (ID: empire)</li>
        <li><strong>Revolution (Empire)</strong> (ID: revolution)</li>
        <li><strong>TakeoverPros (Empire)</strong> (ID: takeover-pros)</li>
    </ul>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
        <strong>âš ï¸ Warning:</strong> This will delete all other teams and reassign their users/closers/leads to the Empire team.
    </div>
    
    <div id="status" style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px;">
        Loading...
    </div>
    
    <div style="margin-top: 20px;">
        <p><strong>Check the browser console for detailed logs.</strong></p>
    </div>
</body>
</html>
